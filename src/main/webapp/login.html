<!DOCTYPE html>
<html lang="en">
<head>
    <title>AWS Javascript Browser SDK: DynamoDB</title>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.0.0-rc12.min.js"></script>
</head>
<body>
    gal login 555
    <div id="amazon-root"></div>
    
    <div id="browserCount"></div>
    <br /><a href="#" id="login">Login</a>
    <a href="#" id="logout">Logout</a>

    <div id="results"></div>

    <script type="text/javascript">
   
    // IAM Role that you create for Login With Amazon
    var roleArn = 'arn:aws:iam::077300967209:role/dynamodb-role';

    // Login with Amazon
    window.onAmazonLoginReady = function() {
        
//        amazon.Login.setClientId('amzn1.application-oa2-client.28747a3df5fa42ffbabadab162bb179c');
        amazon.Login.setClientId('amzn1.application-oa2-client.9e01bf3d77204837acd189ebac83dc11');
    };
    (function(d) {
        var a = d.createElement('script'); a.type = 'text/javascript';
        a.async = true; 
        a.id = 'amazon-login-sdk'; 
        a.src = 'https://api-cdn.amazon.com/sdk/login1.js?v=3';
        d.getElementById('amazon-root').appendChild(a);
    })(document);

    /* if the Login With Amazon authentication is successful
       then detect the browser being used and push it into a DynamoDB table, 
       returning the updated count if the put is successful */
    function amazonAuth(response) {
        if (response.error) {
            console.log(response.error);
            return;
        } 
        AWS.config.credentials = new AWS.WebIdentityCredentials({
            RoleArn: roleArn,
            ProviderId: 'www.amazon.com',
            WebIdentityToken: response.access_token
        });
        amazon.Login.retrieveProfile(response.access_token, function(response) {
            AWS.config.region = 'eu-west-1';
            
            var db = new AWS.DynamoDB();
            var params = {
                TableName: 'Movies',
                 Item:{
                    "year": {N: "2016"},
                    "title": {S: "Gal " + Date.now()}
                }
            };
            
            db.putItem(params, function(err, data) {
                if (err) {
                    console.log(err, err.stack);
                } else {
                    console.log(data);
                }
            });
           
           /////////////////
            var params = {
                TableName: 'Movies',
                Key: {
                    "title": {S: "Gal 123"}
                }
                //, ProjectionExpression: 'ATTRIBUTE_NAME'
            };

            // Call DynamoDB to read the item from the table
            db.getItem(params, function(err, data) {
                if (err) {
                    console.log("Error", err);
                } else {
                    console.log("Success", data.Item);
                }
            });
            
            ///////////////
            
        });
    }

    
    // login with Amazon when you click the Login link
    document.getElementById('login').onclick = function() {
        options = { scope : 'profile' };
        amazon.Login.authorize(options, amazonAuth);
    };

    // logout when you click the Logout link
    document.getElementById('logout').onclick = function() {
        amazon.Login.logout();
        location.reload();
    };


        
    </script>
</body>
</html>
